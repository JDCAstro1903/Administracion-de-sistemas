# Definir la ruta base del FTP 
$FTP_Root = "C:\FTP"
$General_Folder = "$FTP_Root\General"
$Reprobados_Folder = "$FTP_Root\Reprobados"
$Recursadores_Folder = "$FTP_Root\Recursadores"
$Users_Folder = "$FTP_Root\Users"

# Crear estructura de carpetas al mismo nivel
New-Item -ItemType Directory -Path $FTP_Root -Force
New-Item -ItemType Directory -Path $General_Folder -Force
New-Item -ItemType Directory -Path $Reprobados_Folder -Force
New-Item -ItemType Directory -Path $Recursadores_Folder -Force
New-Item -ItemType Directory -Path $Users_Folder -Force

# Instalar el Servidor FTP si no está instalado
Install-WindowsFeature Web-FTP-Server -IncludeManagementTools

# Crear grupos de usuarios
$Reprobados_Group = "FTP_Reprobados"
$Recursadores_Group = "FTP_Recursadores"

New-LocalGroup -Name $Reprobados_Group -ErrorAction SilentlyContinue
New-LocalGroup -Name $Recursadores_Group -ErrorAction SilentlyContinue

# Configurar permisos iniciales
icacls $FTP_Root /grant "ANONYMOUS LOGON:(RX)" /grant "Everyone:(RX)"
icacls $General_Folder /grant "ANONYMOUS LOGON:(RX)" /grant "Everyone:(RX)"
icacls $Reprobados_Folder /grant "ANONYMOUS LOGON:(RX)" /grant "Everyone:(RX)"
icacls $Recursadores_Folder /grant "ANONYMOUS LOGON:(RX)" /grant "Everyone:(RX)"
icacls $Reprobados_Folder /grant "*${Reprobados_Group}:(M)"
icacls $Recursadores_Folder /grant "*${Recursadores_Group}:(M)"

# Preguntar cuántos usuarios agregar
$Num_Users = Read-Host "¿Cuántos usuarios deseas agregar?"

1..([int]$Num_Users) | ForEach-Object {
    $UserName = Read-Host "Ingresa el nombre del usuario $_"
    
    do {
        $PlainPassword = Read-Host "Ingresa la contraseña para $UserName (Mínimo 8 caracteres, debe incluir mayúsculas, minúsculas, números y símbolos)"
        if ($PlainPassword.Length -lt 8 -or 
            !($PlainPassword -match "[A-Z]") -or 
            !($PlainPassword -match "[a-z]") -or 
            !($PlainPassword -match "\d") -or 
            !($PlainPassword -match "[^A-Za-z0-9]")) {
            Write-Host "La contraseña no cumple con los requisitos mínimos de seguridad." -ForegroundColor Red
            continue
        }
        break
    } while ($true)

    $SecurePassword = ConvertTo-SecureString $PlainPassword -AsPlainText -Force
    
    do {
        $UserGroup = Read-Host "¿Grupo del usuario? (1: Reprobados, 2: Recursadores)"
    } while ($UserGroup -ne "1" -and $UserGroup -ne "2")

    # Intentar crear el usuario con manejo de errores mejorado
    try {
        $userParams = @{
            Name = $UserName
            Password = $SecurePassword
            PasswordNeverExpires = $true
            Description = "Usuario FTP"
            ErrorAction = "Stop"
        }
        
        New-LocalUser @userParams
        Write-Host "Usuario $UserName creado exitosamente" -ForegroundColor Green
        
        # Establecer que el usuario no puede cambiar la contraseña usando net user
        net user $UserName /passwordchg:no
        Start-Sleep -Seconds 1
    }
    catch {
        Write-Host "Error al crear el usuario $UserName : $_" -ForegroundColor Red
        continue
    }
    
    # Crear carpeta personal del usuario
    $UserFolder = "$FTP_Root\Users\$UserName"
    New-Item -ItemType Directory -Path $UserFolder -Force
    
    # Asignar permisos al usuario
    icacls $UserFolder /grant "*${UserName}:(M)"
    icacls $General_Folder /grant "*${UserName}:(M)"

    # Asignar usuario al grupo correspondiente
    if ($UserGroup -eq "1") {
        Add-LocalGroupMember -Group $Reprobados_Group -Member $UserName -ErrorAction SilentlyContinue
        icacls $Reprobados_Folder /grant "*${UserName}:(M)"
    } elseif ($UserGroup -eq "2") {
        Add-LocalGroupMember -Group $Recursadores_Group -Member $UserName -ErrorAction SilentlyContinue
        icacls $Recursadores_Folder /grant "*${UserName}:(M)"
    } else {
        Write-Host "Grupo no válido. Usuario no asignado a grupo."
    }
}

# Configurar el servicio FTP
Import-Module WebAdministration
if (!(Get-WebConfiguration -filter "/system.ftpServer")) {
    Write-Host "El servidor FTP no está configurado correctamente en IIS. Verifique la instalación."
    exit
}

New-WebFtpSite -Name "FTP_Site" -PhysicalPath $FTP_Root -Port 21 -Force

# Añadir después de New-WebFtpSite:

# Configurar el firewall para permitir FTP
New-NetFirewallRule -Name "FTP Server" -DisplayName "FTP Server" -Description "Allow FTP traffic" -Profile Any -Direction Inbound -Action Allow -Protocol TCP -LocalPort 21
New-NetFirewallRule -Name "FTP Passive" -DisplayName "FTP Passive" -Description "Allow FTP passive traffic" -Profile Any -Direction Inbound -Action Allow -Protocol TCP -LocalPort 1024-65535

# Configurar el modo pasivo para FTP
$PasiveStartPort = 1024
$PasiveEndPort = 65535

# Configurar rango de puertos pasivos
Set-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/firewallSupport" -name "lowDataChannelPort" -value $PasiveStartPort
Set-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/firewallSupport" -name "highDataChannelPort" -value $PasiveEndPort

# Configurar dirección externa (reemplaza con tu IP pública si es necesario)
$ExternalIp = (Get-NetIPAddress -AddressFamily IPv4 -InterfaceAlias "Ethernet*" | Select-Object -First 1).IPAddress
Set-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/firewallSupport" -name "externalIp4Address" -value $ExternalIp

# Habilitar modo pasivo
Set-ItemProperty "IIS:\Sites\FTP_Site" -Name ftpServer.userIsolation.mode -Value "IsolateAllDirectories"

# Asignar permisos de ejecución al IIS_USRS
$acl = Get-Acl $FTP_Root
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("IUSR","ReadAndExecute", "ContainerInherit,ObjectInherit", "None", "Allow")
$acl.AddAccessRule($rule)
Set-Acl $FTP_Root $acl

# Reiniciar servicios
Restart-Service ftpsvc -Force
iisreset /restart

Write-Host "Configuración del servidor FTP finalizada. Por favor, intenta conectarte usando modo pasivo." -ForegroundColor Green
Write-Host "IP del servidor: $ExternalIp" -ForegroundColor Cyan
Write-Host "Puerto: 21" -ForegroundColor Cyan

# Reemplazar la sección de configuración SSL con:

# Configurar SSL para permitir conexiones no seguras
Set-WebConfigurationProperty -filter "/system.ftpServer/security/ssl" -name "controlChannelPolicy" -value "SslAllow"
Set-WebConfigurationProperty -filter "/system.ftpServer/security/ssl" -name "dataChannelPolicy" -value "SslAllow"
Set-WebConfigurationProperty -filter "/system.ftpServer/security/ssl" -name "ssl128" -value "False"

# Deshabilitar requerimiento de SSL
Set-WebConfigurationProperty -filter "/system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/security/ssl" -name "controlChannelPolicy" -value "SslAllow"
Set-WebConfigurationProperty -filter "/system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/security/ssl" -name "dataChannelPolicy" -value "SslAllow"
Set-WebConfigurationProperty -filter "/system.applicationHost/sites/site[@name='FTP_Site']/ftpServer/security/ssl" -name "ssl128" -value "False"

# Asegurarse de que la autenticación básica esté habilitada
Set-WebConfigurationProperty -filter "/system.ftpServer/security/authentication/basicAuthentication" -name "enabled" -value "True"

# Configurar autenticación
Set-WebConfigurationProperty -filter "/system.ftpServer/security/authentication/anonymousAuthentication" -name "enabled" -value "True"
Set-WebConfigurationProperty -filter "/system.ftpServer/security/authentication/basicAuthentication" -name "enabled" -value "True"

# Verificar si la regla de autorización ya existe antes de agregarla
$existingRule = Get-WebConfiguration "/system.ftpServer/security/authorization" | Where-Object { $_.users -eq "*" -and $_.permissions -eq "Read" }

if (-not $existingRule) {
    Add-WebConfiguration "/system.ftpServer/security/authorization" -value @{
        accessType="Allow";
        users="*";
        permissions="Read";
        roles="";
    }
} else {
    Write-Host "La regla de autorización ya existe. No se añadirá una duplicada."
}

# Reiniciar el servicio FTP
Restart-Service ftpsvc
Write-Host "Configuración del servidor FTP finalizada."
